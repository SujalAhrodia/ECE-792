---
 - hosts: localhost
   become: true
   tasks:
    # Part 1: Create OVS Bridges 
    - name: Add dependencies
      pip:
        name: lxml

    - name: Create OVS bridge
      openvswitch_bridge:
        bridge: "{{item}}"
        state: present
      with_items:
        # - q2sw1
        - q2sw2
        - q2sw3
        - q2sw4
      tags:
        - create_ovs
     
    - name: Change OVS bridge to routed mode
      command: sudo ip addr add 60.0.0.1/24 dev q2sw3
      tags:
        - route
    
    - name: Change OVS bridge to routed mode
      command: sudo ip addr add 70.0.0.1/24 dev q2sw4
      tags:
        - route
    
    # Part 2: Defining the networks
    - name: Define network
      virt_net:
        command: define
        name: "{{item.0}}"
        xml: "{{ lookup('template','./{{item.1}}') }}"
      with_together:
        - ["L2", "L3", "Other"]
        - ["L2.xml.j2", "L3.xml.j2", "Other.xml.j2"]
      tags:
        - define_ovs_network
    
    - name: Start network
      virt_net:
        command: start
        name: "{{item}}"
      with_items:
        - L2
        - L3
        - Other
      tags:
        - start_ovs_net
    
    # - name: Attaching interface to OVS network
    #   command: virsh attach-interface --domain {{item.0}} --type network --source {{item.1}} --model virtio --config --live
    #   with_together:
    #     - ["ssVM1", "ssVM2"]
    #     - ["snet3", "snet4"]
    #   tags:
    #     - attach_interfaces
    
